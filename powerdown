# please use this with xset dpms, hdparm

# turn on kernel options
opt() {
  echo $2 | tee $1 &> /dev/null
  [[ $? != 0 ]] && echo "[powerdown] unavail option: $1"
}

try() {
  $1 &> /dev/null
  [[ $? != 0 ]] && echo "[powerdown] cannot run: $1"
}

# bus
for i in /sys/bus/*/devices/*/power/control; do opt $i auto; done

# nmi_watchdog
opt /proc/sys/kernel/nmi_watchdog 0

# cpu
opt /sys/devices/system/cpu/sched_smt_power_savings 1
opt /sys/devices/system/cpu/sched_mc_power_savings 1
for i in /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor; do opt $i powersave; done

# aspm
opt /sys/module/pcie_aspm/parameters/policy powersave

# kernel write mode
opt /proc/sys/vm/laptop_mode 2
opt /proc/sys/vm/dirty_ratio 60
opt /proc/sys/vm/dirty_background_ratio 40
opt /proc/sys/vm/dirty_expire_centisecs 1500
opt /proc/sys/vm/dirty_writeback_centisecs 1500

# remount noatime
for dev in $(awk '/^\/dev\/sd/ {print $1}' /etc/mtab); do try "mount -o remount,noatime $dev"; done

# Disk powersave
for dev in $(awk '/^\/dev\/sd/ {print $1}' /etc/mtab); do try "hdparm -S 6 -B 1 -a 2048 $dev"; done
for i in /sys/class/scsi_host/host*/link_power_management_policy; do opt $i min_power; done

# Sound card powersave
opt /sys/module/snd_hda_intel/parameters/power_save 1
opt /sys/module/snd_hda_intel/parameters/power_save_controller Y
opt /sys/module/snd_ac97_codec/parameters/power_save 1

# Disable webcam
try "modprobe -r uvcvideo"

# Disable bluetooth
try "modprobe -r btusb"
try "modprobe -r bluetooth"

# wlan0/eth0 powersave
try "iwconfig wlan0 power on"

# Screen powersave
for i in /sys/class/backlight/acpi_video*/brightness; do opt $i 0; done
opt /sys/module/i915/parameters/i915_enable_rc6 1
